name: Download LayoutParser Model

on:
  workflow_dispatch:  # ×”×¤×¢×œ×” ×™×“× ×™×ª

permissions:
  contents: write  # ×”×¨×©××” ×œ×›×ª×™×‘×” ×œ-repo
  
jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install huggingface_hub requests
      
      - name: Download model from Dropbox alternative
        run: |
          python << 'EOF'
          import urllib.request
          from pathlib import Path
          
          print("ğŸ“¥ ××•×¨×™×“ ××•×“×œ PubLayNet...")
          
          # × ×¡×” ××§×•×¨×•×ª ×—×œ×•×¤×™×™×
          urls = [
              # URL ××§×•×¨×™ (Dropbox - ×¢×œ×•×œ ×œ×”×™×—×¡×)
              "https://www.dropbox.com/s/dgy9c10wykk4lq4/model_final.pth?dl=1",
              # Azure blob (Microsoft)
              "https://layoutlm.blob.core.windows.net/detectron2/publaynet/model_final.pth",
          ]
          
          config_url = "https://www.dropbox.com/s/j4yseny2u0hn22r/config.yml?dl=1"
          
          # ×”×•×¨×“ config
          try:
              print("ğŸ“¥ ××•×¨×™×“ config.yml...")
              urllib.request.urlretrieve(config_url, "config.yml")
              print("âœ… config.yml ×”×•×¨×“")
          except Exception as e:
              print(f"âš ï¸ Config × ×›×©×œ: {e}")
          
          # ×”×•×¨×“ model
          success = False
          for i, url in enumerate(urls):
              try:
                  print(f"\nğŸ“¥ ×× ×¡×” ××§×•×¨ {i+1}/{len(urls)}: {url[:50]}...")
                  urllib.request.urlretrieve(url, "model_final.pth")
                  print(f"âœ… ×”×•×¨×“×” ×”×¦×œ×™×—×”!")
                  success = True
                  break
              except Exception as e:
                  print(f"âŒ × ×›×©×œ: {e}")
          
          if not success:
              print("âŒ ×›×œ ×”××§×•×¨×•×ª × ×›×©×œ×•")
              exit(1)
          
          # ×‘×“×•×§ ×’×•×“×œ
          size = Path("model_final.pth").stat().st_size / 1024 / 1024
          print(f"\nğŸ“Š ×’×•×“×œ: {size:.1f} MB")
          
          if size < 100:
              print("âš ï¸ ×”×§×•×‘×¥ ×§×˜×Ÿ ××“×™, ×™×™×ª×›×Ÿ ×©×©×’×™××”")
              exit(1)
          
          print("âœ… ×”××•×“×œ ××•×›×Ÿ ×œ×¤×™×¦×•×œ!")
          EOF
      
      - name: Split model into parts
        run: |
          python << 'EOF'
          from pathlib import Path
          
          print("âœ‚ï¸ ××¤×¦×œ ××ª ×”××•×“×œ...")
          
          input_file = Path("model_final.pth")
          chunk_size = 95 * 1024 * 1024  # 95MB
          
          part_num = 0
          with open(input_file, 'rb') as infile:
              while True:
                  chunk = infile.read(chunk_size)
                  if not chunk:
                      break
                  
                  part_path = f"model_final.pth.part{part_num}"
                  with open(part_path, 'wb') as outfile:
                      outfile.write(chunk)
                  
                  size = len(chunk) / 1024 / 1024
                  print(f"âœ… {part_path} ({size:.1f} MB)")
                  part_num += 1
          
          # ××—×§ ××ª ×”××§×•×¨ (×œ× ×¦×¨×™×š ××•×ª×•)
          input_file.unlink()
          print(f"\nğŸ‰ × ×•×¦×¨×• {part_num} ×—×œ×§×™×")
          EOF
      
      - name: Commit and push files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add model_final.pth.part* config.yml
          git commit -m "ğŸ¤– Add LayoutParser model files (auto-downloaded)" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
